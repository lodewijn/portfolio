---
title: "Simulated Results Multiverse"
format: html
---

```{r}
# Load required packages
library(ggplot2)
```

```{r}
# Set up decision space, where all combinations of decisions are mapped
decision_space <- expand.grid(
 
  datatype       = c("Strict Longitudinal", 
                     "Non-strict Longitudinal",
                     "Cross-sectional"),  
  

  model      = c("Cox Hazard", 
                       "Logistic", 
                       "Log-binomial",
                       "Mixed-effects", 
                       "Discrete Time",
                       "Generalised Estimating Equation"), 
  
  outcome         = c(paste0("Operationalisation ", 1:7)),
  
  confounder      = c("Age", 
                      "Sex", 
                      "Country",
                      "Smoking",
                      "Education",
                      "Physical Activity", 
                      "None")
  )
```

```{r}
# Set seed to ensure reproducibility
set.seed(123)

n <- nrow(decision_space)

# For good visualisation of decision sensitivity
# 2/3 of the resulting odds ratios will follow a normal distribution 
n_norm <- floor(2 * n / 3)

# and 1/3 will follow a beta
n_beta <- n - n_norm

# Conditions for normal distribution
mean <- 1
sd  <- 0.05

# Normally distributed odds ratios
or_norm <- data.frame(
  odds_ratio = unlist(
    lapply(mean, function(mu) {
      exp(rnorm(n_norm, mean = log(mu), sd = sd)) 
    })
  )
) 

# Beta distributed odds ratios
or_beta <- data.frame(odds_ratio = rbeta(n_beta, 3,2))
    
# Create one data frame that contains the decisions and outcomes
dat <- decision_space
dat$odds_ratio <- c(or_norm$odds_ratio, or_beta$odds_ratio)
```

```{r}
# Plot the densities of all outcome distributions to show how they differ
ggplot(dat, aes(x = odds_ratio, colour = outcome)) +
  geom_density(size = 1) +
  geom_vline(xintercept = 1, linetype = "dashed") + # OR = 1, no effect
  labs(
    x = "Odds Ratio",
    y = "Density",
    colour = "Variable operationalisation"
  ) +
  theme_minimal() + 
   theme(text = element_text(size = 20)) 
```

```{r}
# Perform AD-test by comparing OR distributions within each desicion
or <- dat$odds_ratio
decision_outcome <- dat$outcome

# Example for outcome decision
ad_out <- ad.test(or ~ decision_outcome)

# obtain p-value (version 2)
ad_out$ad_out[6] < 0.05
```




